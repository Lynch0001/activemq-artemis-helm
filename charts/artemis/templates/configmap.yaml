apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "artemis.fullname" . }}
  labels:
{{ include "artemis.labels" . | indent 4 }}
data:
  broker.xml: |
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <configuration xmlns="urn:activemq" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:activemq /schema/artemis-configuration.xsd" xmlns:xi="http://www.w3.org/2001/XInclude">
      <core xmlns="urn:activemq:core" xsi:schemaLocation="urn:activemq:core ">

        <xi:include href="../artemis-instance/etc-override/connectors.xml"/>

        <xi:include href="../artemis-instance/etc-override/addresses.xml"/>
        <xi:include href="../artemis-instance/etc-override/address-settings.xml" />

        <cluster-user>{{ .Values.auth.clusterUser }}</cluster-user>
        <xi:include href="../artemis-instance/etc-override/clustering.xml" />

        <xi:include href="../artemis-instance/etc-override/broadcast.xml"/>
        <xi:include href="../artemis-instance/etc-override/discovery.xml"/>

        {{- range $key, $value := .Values.core }}
        <{{ kebabcase $key }}>{{ $value }}</{{ kebabcase $key }}>
        {{- end }}
      </core>
    </configuration>

  broker-ha-live.xml: |
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <configuration xmlns="urn:activemq" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:activemq /schema/artemis-configuration.xsd" xmlns:xi="http://www.w3.org/2001/XInclude">
      <core xmlns="urn:activemq:core" xsi:schemaLocation="urn:activemq:core ">

        <xi:include href="../artemis-instance/etc-override/connectors.xml"/>

        <cluster-user>{{ .Values.auth.clusterUser }}</cluster-user>
        <xi:include href="../artemis-instance/etc-override/clustering.xml" />

        <xi:include href="../artemis-instance/etc-override/broadcast.xml"/>
        <xi:include href="../artemis-instance/etc-override/discovery.xml"/>

        <xi:include href="../artemis-instance/etc-override/addresses.xml"/>
        <xi:include href="../artemis-instance/etc-override/address-settings.xml" />

        <xi:include href="../artemis-instance/etc-override/ha-live.xml" />

        {{- range $key, $value := .Values.core }}
        <{{ kebabcase $key }}>{{ $value }}</{{ kebabcase $key }}>
        {{- end }}
      </core>
    </configuration>

  broker-ha-backup.xml: |
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <configuration xmlns="urn:activemq" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:activemq /schema/artemis-configuration.xsd" xmlns:xi="http://www.w3.org/2001/XInclude">
      <core xmlns="urn:activemq:core" xsi:schemaLocation="urn:activemq:core ">

        <xi:include href="../artemis-instance/etc-override/connectors.xml"/>

        <cluster-user>{{ .Values.auth.clusterUser }}</cluster-user>
        <xi:include href="../artemis-instance/etc-override/clustering.xml" />

        <xi:include href="../artemis-instance/etc-override/broadcast.xml"/>
        <xi:include href="../artemis-instance/etc-override/discovery.xml"/>

        <xi:include href="../artemis-instance/etc-override/addresses.xml"/>
        <xi:include href="../artemis-instance/etc-override/address-settings.xml" />

        <xi:include href="../artemis-instance/etc-override/ha-backup.xml" />

        {{- range $key, $value := .Values.core }}
        <{{ kebabcase $key }}>{{ $value }}</{{ kebabcase $key }}>
        {{- end }}
      </core>
    </configuration>

  connectors.xml: |
    <connectors xmlns="urn:activemq:core">
      <connector name="netty">tcp://$EXTERNAL_NAME.$EXTERNAL_NAMESPACE.artemis.svc.cluster.local:61616</connector>
    </connectors>

  clustering.xml: |
    <cluster-connections xmlns="urn:activemq:core">
      <cluster-connection name="{{ include "artemis.fullname" . }}">
        <address>{{ .Values.clustering.addresses | join "," }}</address>
        <connector-ref>netty</connector-ref>
        {{- range $key, $value := (omit .Values.clustering "address" "addresses" "connector-ref" "discovery-group-ref") }}
        <{{ kebabcase $key }}>{{ $value }}</{{ kebabcase $key }}>
        {{- end }}
        <discovery-group-ref discovery-group-name="jgroups-discovery" />
      </cluster-connection>
    </cluster-connections>

  broadcast.xml: |
    <broadcast-groups xmlns="urn:activemq:core">
      <broadcast-group name="jgroups-broadcast">
        <jgroups-file>jgroups-discovery.xml</jgroups-file>
        <jgroups-channel>activemq_broadcast_channel</jgroups-channel>
        <connector-ref>netty</connector-ref>
      </broadcast-group>
    </broadcast-groups>

  discovery.xml: |
    <discovery-groups  xmlns="urn:activemq:core" >
      <discovery-group name="jgroups-discovery">
          <jgroups-file>jgroups-discovery.xml</jgroups-file>
          <jgroups-channel>activemq_broadcast_channel</jgroups-channel>
          <refresh-timeout>10000</refresh-timeout>
      </discovery-group>
    </discovery-groups>

  jgroups-discovery.xml: |
    <config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="urn:org:jgroups"
        xsi:schemaLocation="urn:org:jgroups http://www.jgroups.org/schema/jgroups.xsd">

      <TCP
          bind_addr="${jgroups.bind_addr:site_local}"
          bind_port="${jgroups.bind_port:7800}"
          external_addr="${jgroups.external_addr}"
          external_port="${jgroups.external_port}"
          thread_pool.min_threads="0"
          thread_pool.max_threads="200"
          thread_pool.keep_alive_time="30000"
      />

      <dns.DNS_PING
          dns_query="artemis-ping"
          dns_record_type="${DNS_RECORD_TYPE:A}"
      />

      <MERGE3 min_interval="10000"
              max_interval="30000"/>
        <FD_SOCK2/>
        <FD_ALL3 timeout="40000" interval="5000" />
        <VERIFY_SUSPECT2 timeout="1500"  />
        <pbcast.NAKACK2 use_mcast_xmit="false" />
        <UNICAST3 />
        <pbcast.STABLE desired_avg_gossip="50000"
                       max_bytes="4M"/>
        <pbcast.GMS print_local_addr="true" join_timeout="2000"/>
        <UFC max_credits="2M"
             min_threshold="0.4"/>
        <MFC max_credits="2M"
             min_threshold="0.4"/>
        <FRAG2 frag_size="60K"  />
      <pbcast.STATE_TRANSFER/>
      <CENTRAL_LOCK />
      <COUNTER/>
    </config>

  addresses.xml: |
    <addresses xmlns="urn:activemq:core">
    {{- range .Values.addresses }}
      <address name="{{ required "name is mandatory for each address" .name }}">
      {{- if eq "queue" (default "queue" .type) }}
        <anycast>
        {{- if .queues }}
            {{- range .queues }}
              <queue name="{{ . }}" />
            {{- end }}
        {{- else }}
            <queue name="{{ .name }}" />
        {{- end }}
        </anycast>
      {{- else if eq "topic" .type }}
        {{- if .queues }}
        <multicast>
          {{- range .queues }}
             <queue name="{{ . }}" />
          {{- end }}
        </multicast>
        {{- else }}
        <multicast />
        {{- end }}
      {{- else }}
        {{- fail "invald address type. Can only be 'queue' or 'topic'"}}
      {{- end }}
      </address>
    {{- end }}
    </addresses>

  address-settings.xml: |
    <address-settings xmlns="urn:activemq:core">
    {{- range .Values.addressSettings }}
       <address-setting match="{{ required "match is mandatory for each addressSetting" .match }}">
       {{- range $key, $value := .settings }}
        <{{ kebabcase $key }}>{{ $value }}</{{ kebabcase $key }}>
       {{- end }}
       </address-setting>
    {{- end }}
    </address-settings>

  ha-live.xml: |
    <ha-policy xmlns="urn:activemq:core">
      <replication>
          <master>
            <check-for-live-server>true</check-for-live-server>
            {{- range $key, $value := (omit .Values.ha.live "check-for-live-server" "checkForLiveServer") }}
            <{{ kebabcase $key }}>{{ $value }}</{{ kebabcase $key }}>
            {{- end }}
          </master>
      </replication>
    </ha-policy>

  ha-backup.xml: |
    <ha-policy xmlns="urn:activemq:core">
      <replication>
          <slave>
            <allow-failback>true</allow-failback>
            {{- range $key, $value := (omit .Values.ha.backup "allow-failback" "allowFailback") }}
            <{{ kebabcase $key }}>{{ $value }}</{{ kebabcase $key }}>
            {{- end }}
          </slave>
      </replication>
    </ha-policy>

  broker-00.xslt: |
    <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

      <xsl:output omit-xml-declaration="yes"/>

      <xsl:template match="node()|@*">
        <xsl:copy>
         <xsl:apply-templates select="node()|@*"/>
        </xsl:copy>
      </xsl:template>

      <xsl:template match="*[local-name()='addresses']|*[local-name()='address-settings']"/>
    </xsl:stylesheet>

  login.config: |
    activemq {
      org.apache.activemq.artemis.spi.core.security.jaas.PropertiesLoginModule sufficient
      debug=false
      reload=true
      org.apache.activemq.jaas.properties.user="artemis-users.properties"
      org.apache.activemq.jaas.properties.role="artemis-roles.properties";

      org.apache.activemq.artemis.spi.core.security.jaas.GuestLoginModule sufficient
      debug=false
      org.apache.activemq.jaas.guest.user="artemis"
      org.apache.activemq.jaas.guest.role="admin";
    };
